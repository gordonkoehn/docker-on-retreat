<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>Docker on Retreat</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/fontawesome.min.css" rel="stylesheet">
        <link href="css/brands.min.css" rel="stylesheet">
        <link href="css/solid.min.css" rel="stylesheet">
        <link href="css/v4-font-face.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body class="homepage">
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href=".">Docker on Retreat</a>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#welcome-to-docker-on-retreat" class="nav-link">Welcome to Docker on Retreat</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#prerequisites" class="nav-link">Prerequisites</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#creating-your-program" class="nav-link">Creating your Program.</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#credits" class="nav-link">Credits</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="welcome-to-docker-on-retreat">Welcome to Docker on Retreat</h1>
<p>This document and repo has a minimal viable example of how to develop a python application containerized/dockerized locally and run it on the cluster.</p>
<p>We have a small python script that relies on a few dependencies installed via <em>Conda</em>.
Our python script requires some input files and prints and creates some output.</p>
<p>A typical flow of a scientific investigation.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>This workbook is meant for a quick life demo, hence it may be better to just follow. Yet if you want to take the challange. Please make sure your machine is set up. </p>
<p>Install Docker on your local computer and create an account on <a href="https://hub.docker.com/">dockerhub</a>. You can find instructions <a href="https://docs.docker.com/get-started/get-docker/">here</a>. Note that you need admin rights to install and use Docker, and if you are installing Docker on Windows, you need a recent Windows version. </p>
<p>Please also login into your docker hub account in the Docker GUI or with </p>
<pre><code>docker login
</code></pre>
<details>
<summary>If working on Windows</summary>

During the course exercises you will be mainly interacting with docker through the command line. Although windows powershell is suitable for that, it might cause some issues with bind mounting directories. Hence, it is easier to follow the exercises if you have a UNIX or ‘UNIX-like’ terminal. You can get one by using WSL2. With VScode, you can also add the WSL extension. Make sure you install the latest versions before installing docker.

</details>

<h2 id="creating-your-program">Creating your Program.</h2>
<p>Our example program is in <code>src/main.py</code>. Let's check it out:
- We import some libraries, supported by our virtual environment manager <em>Conda</em>. See <code>environment.yml</code>.
- We get out input and output paths.
- We import the data. Two float numbers.
- We do some heavy computation with <em>numpy</em>.
- We do some Output Formating with a cool, but useless tool called <em>figlet</em>. You'll see.
- We save the result, to the output file and console.</p>
<h3 id="make-a-docker-out-of-it">Make a docker out of it.</h3>
<p>Make sure you are in the root directory of this project.</p>
<pre><code>docker build .
</code></pre>
<p>What just happened? This command refers to the Docker Engine, the Runtime engine of this particular containerization technology. This command be default looks in the current directory for the container <em>Manifest</em>, for Dockers the <em>Dockerfile</em>. It contains all the instructions to make the image. The above command did just that. It build the image given the instructions in the manifest. So where is the image ? We'll it's not a file you see. But you can check for it with:</p>
<pre><code>docker image list
</code></pre>
<p>Let's properly name our container now. But before take care if you have..</p>
<details>
<summary>If using an Apple M chip (newer Macs)</summary>

If you are using a computer with an Apple M chip, you have the less common ARM system architecture, which can limit transferability of images to (more common) x86_64/AMD64 machines. When building images on a Mac with an M chip (especially if you have sharing in mind), it’s best to set the DOCKER_DEFAULT_PLATFORM to linux/amd64 with:


<pre><code>export DOCKER_DEFAULT_PLATFORM=linux/amd64
</code></pre>


This is unfortunate currently, but containers protect us for any issues with operating systems but the chip-set may still cause issues, so it's best to use the default. Especially because clusters won't use ARM chips. Clusters are not optimized for energy efficiency that way.

</details>

<pre><code>docker build -t beatenberg:v1 .
</code></pre>
<p>Let's check again </p>
<pre><code>docker image list
</code></pre>
<p>Now you should see your container with a tag in the list.</p>
<p>Let's check the input and output files in 
<code>in/input.csv</code> and <code>out/output.txt</code>.</p>
<p>Let's now run the docker locally. Because we have input and output files we need to mount these directories. As a container isolates your application with seemingly its own operating system and file system. To get data in and out, you need to mount. We already saw which are the directories used inside of the container. Next, we define their equivalent outside of the container and run it. The next command takes the image we just created and makes a container out of it.</p>
<pre><code>docker run -v $(pwd)/in:/app/in -v $(pwd)/out:/app/out beatenberg:v1
</code></pre>
<p>Woha, this worked. And it's quite useful. This gets useful if your installation is complicated or unreliable across machines.</p>
<p>Note that this container just runs and exits, that's usually what we want on a cluster.</p>
<p>Let's look inside for context.</p>
<pre><code>docker run -v $(pwd)/in:/app/in -v $(pwd)/out:/app/out -it beatenberg:v1 /bin/bash
</code></pre>
<p>There is our application. And look its ubuntu.</p>
<p>In another terminal, let's see this container:</p>
<pre><code>docker ps
</code></pre>
<p>It shows information about the containers that are currently running, including their container ID, image, command, creation time, status, ports, and names. </p>
<p>To see all containers, including those that are stopped, you can use the -a flag:</p>
<pre><code>docker ps -a
</code></pre>
<h3 id="lets-share-the-image">Let's share the image</h3>
<p>Now we will share the image to dockerhub. If you haven't already you have to login to your dockerhub account with:</p>
<pre><code>docker login
</code></pre>
<p>Now that we have created our first own docker image, we can store it and share it with the world on docker hub. Before we get there, we first have to (re)name and tag it.</p>
<p>Before pushing an image to dockerhub, docker has to know to which user and which repository the image should be added. That information should be in the name of the image, like this: user/imagename. We can rename an image with docker tag (which is a bit of misleading name for the command). So we could push to dockerhub like this:</p>
<pre><code>docker tag beatenberg:v1 [USER NAME]/beatenberg:v1
docker push [USER NAME]/beatenberg:v1
</code></pre>
<p>So you just shared your image with the world.</p>
<h3 id="lets-run-it-on-the-cluster">Let's run it on the cluster</h3>
<p>On a cluster there is no container runtime engine, hence we cannot use <em>docker</em>, but instead we are going to use <em>apptainer</em>.</p>
<p>Apptainer can take several image formats (e.g. a docker image), and convert them into it’s own .sif format. Unlike docker this image doesn’t live in a local image cache, but it’s stored as an actual file.</p>
<p>We can get our image from <em>dockerhub</em> with:</p>
<pre><code>apptainer pull docker://[USER NAME]/[IMAGE NAME]:[TAG]
</code></pre>
<p>so </p>
<pre><code>apptainer pull docker://[USER NAME]/beatenberg:v1
</code></pre>
<p>if you got stuck just use mine:</p>
<pre><code>apptainer pull docker://gordonkoehn/beatenberg:v1
</code></pre>
<p>Let's have a look:</p>
<pre><code>ls
</code></pre>
<p>Look there is the <code>.sif</code>, this is the image in apptainer format.</p>
<p>Getting the Image uploaded and download it to euler may take while, so let's use a smaller image: </p>
<pre><code>apptainer pull docker://geertvangeest/ubuntu-figlet:v3
</code></pre>
<p>and then to run it.</p>
<pre><code>./ubuntu-figlet_v3.sif
</code></pre>
<p>Back to our big image.</p>
<p>Apptainer is also different from Docker in the way it handles mounting. By default, Apptainer binds your home directory and a number of paths in the root directory to the container. This results in behaviour that is almost like if you are working on the directory structure of the host.</p>
<pre><code>apptainer exec --bind /my/dir/to/mount/ [IMAGE NAME].sif [COMMAND]
</code></pre>
<p>so for us </p>
<pre><code>apptainer exec --bind /my/dir/to/mount/ [IMAGE NAME].sif [COMMAND]
</code></pre>
<p>These .sif files can be run as standalone executables:</p>
<pre><code>./beatenberg_v1.sif
</code></pre>
<p>This is shorthand for:</p>
<pre><code>apptainer run beatenberg_v1.sif
</code></pre>
<p>But let us just run this one command to do it all.</p>
<pre><code>apptainer exec --env-file .env --bind $(pwd)/in:/app/in --bind $(pwd)/out:/app/out beatenberg_v1.sif python /app/main.py
</code></pre>
<p>We will skip running our full program as this creating of apptrainer can take a while.</p>
<p>So let's use something simpler:</p>
<h2 id="credits">Credits</h2>
<p>This mini course is a distillate and derivatieve of the Swiss Institute of Bioinformatics course called <a href="https://sib-swiss.github.io/containers-snakemake-training/latest/course_material/day1/introduction_containers/">Introduction to Containers and Snakemake</a>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js"></script>
        <script src="search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 1.6.1
Build Date UTC : 2025-01-09 17:03:42.727947+00:00
-->
